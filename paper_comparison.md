# Pro Trader RL - 論文與實作完整比對分析

> **目的**: 逐項比對論文規格與目前程式碼實作，確保除刻意差異外一致

---

## 📊 總覽

| 項目 | 論文 | 實作 | 狀態 |
|------|------|------|------|
| 狀態維度 (Buy) | 69 | 69 | ✅ 一致 |
| 狀態維度 (Sell) | 70 | 70 | ✅ 一致 |
| 神經網路 (Buy) | 69→40→2 | 69→40→2 | ✅ 一致 |
| 神經網路 (Sell) | 70→40→2 | 70→40→2 | ✅ 一致 |
| PPO 超參數 | Table 6 | config | ✅ 一致 |
| 成功門檻 | 10% | 10% | ✅ 一致 |
| 賣出信心門檻 | 0.85 | 0.85 | ✅ 一致 |
| 停損閾值 | -10% | -10% | ✅ 一致 |
| 盤整天數 | 20天 | 20天 | ✅ 一致 |
| 最大持有 | 120天 | 120天 | ✅ 一致 |
| 初始資金 | $10,000 | $10,000 | ✅ 一致 |
| 最大持倉 | 10檔 | 10檔 | ✅ 一致 |
| 手續費 | 0.1% | 0.1% | ✅ 一致 |
| 回測期間 | 2017/10/16-2023/10/15 | 相同 | ✅ 一致 |
| 指數選擇 | Dow Jones (^DJI) | S&P 500 (^GSPC) | ⚠️ 差異 |
| Buy 獎勵函數 | +1/0 | +1/-1 | ⚠️ 差異 |
| 訓練資料來源 | S&P 500+400+600 | S&P 500 only | ⚠️ 差異 |

---

## 1. 特徵計算 (Feature Engineering)

### 1.1 基本變數 (9個)

| 變數 | 論文 | 實作 (`feature_calculator.py`) | 狀態 |
|------|------|------|------|
| Open | ✓ | ✓ | ✅ |
| High | ✓ | ✓ | ✅ |
| Low | ✓ | ✓ | ✅ |
| Close | ✓ | ✓ | ✅ |
| Volume | 排除 | 使用 log+z-score | ⚠️ 我們有用 |
| HA_Open | ✓ | ✓ | ✅ |
| HA_High | ✓ | ✓ | ✅ |
| HA_Low | ✓ | ✓ | ✅ |
| HA_Close | ✓ | ✓ | ✅ |

### 1.2 技術指標 (21個)

| 指標 | 論文參數 | 實作參數 | 狀態 |
|------|----------|----------|------|
| Return | 日報酬 | 日報酬 | ✅ |
| ATR | N=10 | N=10 | ✅ |
| Stock_N (12個) | N=1-12月 | N=1-12月 | ✅ |
| SuperTrend (2個) | (14,2), (21,1) | (14,2), (21,1) | ✅ |
| MFI | N=14 | N=14 | ✅ |
| RSI | N=14 | N=14 | ✅ |
| Donchian Upper | N=20 | N=20 | ✅ |
| Donchian Lower | N=20 | N=20 | ✅ |
| AVG_Stock | 1,3,6,12月平均 | 1,3,6,12月平均 | ✅ |

### 1.3 指數變數 (13個)

| 變數 | 論文 | 實作 | 狀態 |
|------|------|------|------|
| Index ATR | DJI ATR | S&P 500 ATR | ⚠️ 指數不同 |
| Index_N (12個) | DJI 波動比 | S&P 500 波動比 | ⚠️ 指數不同 |

> **差異說明**: 論文使用 Dow Jones (^DJI) 作為基準指數，我們使用 S&P 500 (^GSPC)。這可能影響 RS 相關特徵的計算。

### 1.4 相對強度變數 (26個)

| 變數 | 論文 | 實作 | 狀態 |
|------|------|------|------|
| RS_N (12個) | Stock_N / Index_N | ✓ | ✅ |
| RS_AVG | 1,3,6,12月平均 | ✓ | ✅ |
| AVG_Index | Index_N 平均 | ✓ | ✅ |
| RS_Rate | 0-100 | ✓ | ✅ |
| RS_Rate_N (4個) | MA 5,10,20,40 | ✓ | ✅ |
| Up_Stock | 漲股家數 | ✓ | ✅ |
| Down_Stock | 跌股家數 | ✓ | ✅ |

---

## 2. 正規化公式 (Normalization)

### 2.1 公式 1-8: 價格比率

| 公式 | 論文 (疑似筆誤) | 實作 (`normalizer.py`) | 狀態 |
|------|----------------|------------------------|------|
| (1) Donchian_Upper | Upper/High | Upper/High | ✅ |
| (2) Donchian_Lower | Lower/Low | Lower/Low | ✅ |
| (3) Close | Upper/High ❌ | Close/High | ✅ 修正 |
| (4) Low | Upper/High ❌ | Low/High | ✅ 修正 |
| (5) High | Upper/High ❌ | High/High = 1 | ✅ 修正 |
| (6) HA_Close | 同上 | HA_Close/HA_High | ✅ 修正 |
| (7) HA_Low | 同上 | HA_Low/HA_High | ✅ 修正 |
| (8) HA_High | 同上 | HA_High/HA_High = 1 | ✅ 修正 |

> **說明**: 論文公式 3-8 有明顯筆誤，我們採用合理的修正版本。

### 2.2 公式 9-10: 時間變化比率

| 公式 | 論文 | 實作 | 狀態 |
|------|------|------|------|
| (9) Index_ATR | ATR_t / ATR_{t-1} | ✓ | ✅ |
| (10) ATR | ATR_t / ATR_{t-1} | ✓ | ✅ |

### 2.3 公式 11-15: 滾動 MinMax

| 公式 | 論文 | 實作 | 狀態 |
|------|------|------|------|
| (11) Index | 12月 MinMax | 252天滾動 | ✅ |
| (12) Stock | 12月 MinMax | 252天滾動 | ✅ |
| (13) AVG_Stock | 同上 | ✓ | ✅ |
| (14) RS | 12月 MinMax | ✓ | ✅ |
| (15) RS_AVG | 同上 | ✓ | ✅ |

### 2.4 公式 16-18: 百分比縮放

| 公式 | 論文 | 實作 | 狀態 |
|------|------|------|------|
| (16) RS_Rate | × 0.01 | ✓ | ✅ |
| (17) MFI | × 0.01 | ✓ | ✅ |
| (18) RSI | × 0.01 | ✓ | ✅ |

---

## 3. Buy Knowledge RL

### 3.1 環境設計

| 項目 | 論文 | 實作 (`buy_env.py`) | 狀態 |
|------|------|---------------------|------|
| 狀態維度 | 69 | 69 | ✅ |
| 動作空間 | 2 (買/不買) | 2 (0:不買, 1:買) | ✅ |
| 成功定義 | 報酬 ≥ 10% | 報酬 ≥ 10% | ✅ |
| 資料平衡 | 1:1 | 1:1 | ✅ |
| Top-K 選股 | Top 10 | 未實作 | ⚠️ 待確認 |

### 3.2 獎勵函數

| 情境 | 論文 | 實作 | 狀態 |
|------|------|------|------|
| 預測買+實際成功 | **+1** | +1 | ✅ |
| 預測買+實際失敗 | **0** | **-1** | ⚠️ 差異 |
| 預測不買+實際失敗 | **+1** | +1 | ✅ |
| 預測不買+實際成功 | **0** | **-1** | ⚠️ 差異 |

> **差異分析**: 論文對錯誤預測給 0 分，我們給 -1 分。這會讓 AI 更「害怕犯錯」，可能導致過度保守。但也可能加速學習。

### 3.3 PPO 超參數 (Table 6)

| 參數 | 論文 | 實作 (`config`) | 狀態 |
|------|------|-----------------|------|
| learning_rate | 0.0001 | 0.0001 | ✅ |
| n_steps | 2048 | 2048 | ✅ |
| batch_size | 64 | 64 | ✅ |
| n_epochs | 10 | 10 | ✅ |
| gamma | 0.99 | 0.99 | ✅ |
| gae_lambda | 0.95 | 0.95 | ✅ |
| clip_range | 0.2 | 0.2 | ✅ |
| ent_coef | 0.01 | 0.01 | ✅ |
| vf_coef | 0.5 | 0.5 | ✅ |
| max_grad_norm | 0.5 | 0.5 | ✅ |

### 3.4 神經網路架構

| 層 | 論文 | 實作 | 狀態 |
|------|------|------|------|
| 輸入層 | 69 | 69 | ✅ |
| 隱藏層 | 40 | 40 | ✅ |
| 輸出層 | 2 | 2 | ✅ |
| Actor/Critic | 相同結構 | pi:[69,40], vf:[69,40] | ✅ |

---

## 4. Sell Knowledge RL

### 4.1 環境設計

| 項目 | 論文 | 實作 (`sell_env.py`) | 狀態 |
|------|------|----------------------|------|
| 狀態維度 | 70 (69+SellReturn) | 70 | ✅ |
| SellReturn 公式 | Open_t / BuyPrice (Eq.20) | ✓ | ✅ |
| 動作空間 | 2 (持有/賣出) | 2 (0:持有, 1:賣出) | ✅ |
| 最大持有天數 | 120 | 120 | ✅ |
| 賣出信心門檻 | sell-hold > 0.85 | 0.85 | ✅ |
| 訓練資料過濾 | 只用成功交易 | ✓ | ✅ |

### 4.2 獎勵函數 (4情境)

| 情境 | 論文 | 實作 | 狀態 |
|------|------|------|------|
| 賣出+獲利≥10% | **排名獎勵 +1~+2** | 排名獎勵 +1~+2 | ✅ |
| 賣出+獲利<10% | **-1** | -1 | ✅ |
| 持有+獲利<10% | **+0.5** | +0.5 | ✅ |
| 持有+獲利≥10% | **-1** | -1 | ✅ |

### 4.3 排名獎勵 (Eq.21)

| 項目 | 論文 | 實作 | 狀態 |
|------|------|------|------|
| 計算範圍 | 120天內≥10%的日子 | ✓ | ✅ |
| 公式 | rank/total + 1 | ✓ | ✅ |
| 獎勵範圍 | +1 到 +2 | +1 到 +2 | ✅ |

### 4.4 神經網路架構

| 層 | 論文 | 實作 | 狀態 |
|------|------|------|------|
| 輸入層 | 70 | 70 | ✅ |
| 隱藏層 | 40 | 40 | ✅ |
| 輸出層 | 2 | 2 | ✅ |

---

## 5. 停損規則 (Stop Loss)

### 5.1 跌幅停損 (Stop Loss on Dips)

| 項目 | 論文 | 實作 (`stop_loss.py`) | 狀態 |
|------|------|----------------------|------|
| 觸發條件 | 報酬率 < -10% | < -10% | ✅ |
| 執行時機 | 隔天開盤價 | 隔天開盤 | ✅ |

### 5.2 盤整停損 (Stop Loss on Sideways)

| 項目 | 論文 | 實作 | 狀態 |
|------|------|------|------|
| 觀察天數 | 連續 20 天 | 20 | ✅ |
| 觸發條件 | 報酬率 < 10% | < 10% | ✅ |
| 最大持有 | 120 天內 | 120 | ✅ |
| 執行時機 | 第 21 天開盤 | ✓ | ✅ |

### 5.3 優先級

| 項目 | 論文 | 實作 | 狀態 |
|------|------|------|------|
| 優先級 | 停損 > Sell Agent | ✓ | ✅ |
| Override | 停損覆蓋 Agent 決策 | ✓ | ✅ |

---

## 6. 投資組合設定

| 項目 | 論文 | 實作 (`config`) | 狀態 |
|------|------|-----------------|------|
| 初始資金 | $10,000 | $10,000 | ✅ |
| 最大持倉 | 10 檔 | 10 | ✅ |
| 單檔上限 | 10% | 10% | ✅ |
| 手續費 | 0.1% | 0.1% | ✅ |

---

## 7. 回測設定

| 項目 | 論文 | 實作 | 狀態 |
|------|------|------|------|
| 訓練期間 | 2005/02/25 - 2017/10/15 | ✓ | ✅ |
| 測試期間 | 2017/10/16 - 2023/10/15 | ✓ | ✅ |
| 資產池 | S&P 500+400+600 (1465檔) | S&P 500 only | ⚠️ 差異 |

---

## 8. 關鍵差異匯總

### 8.1 刻意的差異 (設計決策)

| 項目 | 論文 | 實作 | 理由 |
|------|------|------|------|
| 基準指數 | Dow Jones | S&P 500 | S&P 500 更具代表性 |
| 資產池 | 1465檔 | ~500檔 | 簡化資料處理 |

### 8.2 需要確認的差異

| 項目 | 論文 | 實作 | 影響 |
|------|------|------|------|
| Buy 錯誤懲罰 | 0 | -1 | 可能過度保守 |
| Top-10 選股 | 明確實作 | 待確認 | 影響資金分配 |
| Volume | 排除 | 包含 | 可能增加雜訊 |

### 8.3 論文筆誤 (我們修正)

| 項目 | 論文 | 修正 |
|------|------|------|
| 公式 3-8 | 全部相同 (Upper/High) | 各自變數/High |
| 公式 19 分母 | SellPrice | BuyPrice (標準) |

---

## 9. 建議修改

### 高優先

1. **Buy Agent 獎勵函數**: 考慮將錯誤預測從 -1 改為 0，與論文一致
2. **Top-10 選股邏輯**: 確認 backtest 是否實作了同日多訊號時選信心最高的 Top 10

### 中優先

3. **基準指數**: 可考慮切換到 DJI 以完全對齊論文
4. **資產池擴展**: 可考慮加入 S&P 400/600

### 低優先

5. **Volume 處理**: 論文排除 Volume，可考慮移除以對齊
6. **公式 19 修正**: 確認 SignalReturn 分母使用 BuyPrice

---

## 10. 檢查清單

- [x] PPO 超參數 - 完全一致
- [x] 神經網路架構 - 完全一致
- [x] Sell Agent 4 情境獎勵 - 完全一致
- [x] 停損規則 - 完全一致
- [x] 投資組合設定 - 完全一致
- [x] 回測期間 - 完全一致
- [ ] Buy Agent 獎勵 - **需確認是否需修改**
- [ ] Top-10 選股 - **需確認實作**
- [ ] 基準指數 - **已知差異，可接受**
